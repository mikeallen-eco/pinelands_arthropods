# Arthropod metabarcoding (4 methods): 'substrate comparison' study
First field effort testing 4 methods with n = 2-5 samples each (spray, roller, water, and soil).

# Load libraries. Read, clean and format data
```{r}
library(dplyr)
library(metacoder)
library(readxl)
library(ggplot2)
library(stringr)
library(taxa)
library(vegan)
library(BiodiversityR)
library(wesanderson)
library(patchwork)
library(tidyr)
library(forcats)
select <- dplyr::select
'%notin%' <- Negate('%in%')
# path for taxonomy and ecology lookup tables
tax_data_path <- "data/arthropod.families_20220831.xlsx"
# note: the 20220816 version is up-to-date for 2methods
#   but hadn't received new families from 4methods yet

# read in family name look up 
    # will use to match each OTU with an NCBI family name
    # created by looking up each entry in NCBI if it didn't 
      # have a family name yet from bioinformatics work
famlookup <- read_xlsx(tax_data_path, 
                       sheet = "arthropod.families") %>%
  select(final_ID = 'final species_name',
         family:kingdom) %>%
  distinct()

# read in family trait info (life mode)
    # note: class and order added with taxize package using script:
    # "scripts/adding_taxonomy_to_families.R"
    # terrestrial/aquatic info from Horren et al. database & others
lifemode <- read_xlsx(tax_data_path, 
                      sheet = "arthropod.families.lifemode") %>%
  select(-person) %>%
  mutate(life.cat = case_when(larva_aquatic >= 1 & 
                                 adult_aquatic >= 1 ~ 
                                 "Fully aquatic",
                               larva_terrestrial >= 1 &
                                 adult_terrestrial >= 1 ~ 
                                 "Fully terrestrial",
                               larva_aquatic >= 1 &
                                 adult_terrestrial >= 1 ~
                                 "All larvae aquatic",
                               TRUE ~ "Some larvae aquatic"))

# read in family trait info (diet/feeding)
    # note: class and order added with taxize package using script:
    # "scripts/adding_taxonomy_to_families.R"
    # diet/feeding info from Horren et al. database & others
diet <- read_xlsx(tax_data_path, 
                      sheet = "arthropod.families.diet") %>%
  select(-person) %>%
  # create a condensed diet/feeding classification
  mutate(diet.cat = case_when(final_diet == "mixed" ~ 
                                "multiple categories",
                              final_diet %in% 
                                c("zoophagous", "phytophagous") ~
                                paste(final_diet, feed_mode, 
                                      sep = "-"),
                              final_diet %in% c("saprophagous", 
                                                "detritophagous") ~ 
                                "detritophagous/scavenger",
                              TRUE ~ final_diet),
         diet.cat = case_when(notes == ".9 det/sap/cop" ~ 
                                "detritophagous/scavenger",
                              family %in% c("Calliphoridae",
                                                  "Polleniidae",
                                                  "Rhiniidae") ~
                                "detritophagous/scavenger",
                              diet.cat == "zoophagous-necro" ~
                                "detritophagous/scavenger",
                           diet.cat %in% c("phytophagous-mixed",
                                        "phytophagous-not specified") ~
                             "phytophagous-multiple/other",
                           diet.cat == "phytophagous-flower" ~
                             "phytophagous-multiple/other",
                           diet.cat %in% c("phytophagous-miners",
                                           "phytophagous-gall") ~
                             "phytophagous-galls/miners",
                           diet.cat %in% c("zoophagous-parasite",
                                           "zoophagous-parasitoid",
                                           "zoophagous-micropredator") ~
                             "zoophagous-parasite/parasitoid",
                              TRUE ~ diet.cat),
         diet.cat2 = case_when(diet.cat == 
                                "detritophagous/scavenger" ~ 
                                "Scavenger",
                               diet.cat == 
                                "zoophagous-necrophorous" ~ 
                                "Scavenger",
                              diet.cat == 
                                "phytophagous-galls/miners" ~
                                "Phytophagous",
                              diet.cat == 
                                "phytophagous-roots" ~
                                "Phytophagous",
                              diet.cat == 
                                "phytophagous-multiple/other" ~
                                "Phytophagous",
                              diet.cat == 
                                "phytophagous-phyllophagous" ~
                                "Phytophagous",
                              diet.cat == 
                                "phytophagous-sap sucking" ~
                                "Phytophagous",
                              diet.cat == 
                                "phytophagous-saproxylic" ~
                                "Phytophagous",
                              diet.cat == 
                                "zoophagous-parasite/parasitoid" ~
                                "Parasite/parasitoid",
                              diet.cat == 
                                "zoophagous-predator" ~
                                "Predator",
                              diet.cat == 
                                "zoophagous-mixed" ~
                                "Mulitple categories",
                              diet.cat == 
                                "multiple categories" ~
                                "Mulitple categories",
                              diet.cat == 
                                "mycetophagous" ~
                                "Mycetophagous",
                              TRUE ~ diet.cat))

table(diet$diet.cat)
table(diet$diet.cat2)
# final category notes: 
# detritophagous/scavenger = detrit., copro., sapro., and zoo.-necro.

# read in family trait info (body size)
    # note: class and order added with taxize package using script:
    # "scripts/adding_taxonomy_to_families.R"
    # diet/feeding info from Horren et al. database & others
size <- read_xlsx(tax_data_path, 
                      sheet = "arthropod.families.size") %>%
  select(-person) %>%
  select(family:final_source) %>%
  mutate(Body_Size = case_when(final_mid > 20 ~ ">20 mm",
                               final_mid > 10 & 
                                 final_mid <= 20 ~ "10-20 mm",
                               final_mid > 5 &
                                 final_mid <= 10 ~ "5-10 mm",
                               final_mid <= 5 ~ "<5 mm",
                               TRUE ~ "Unknown"),
         Body_Size_order = case_when(Body_Size == "<5 mm" ~ 5,
                           Body_Size == "5-10 mm" ~ 4,
                           Body_Size == "10-20 mm" ~ 3,
                           Body_Size == ">20 mm" ~ 2,
                           Body_Size == "Unknown" ~ 1)
  )

# read in OTU data for coleop primer set and add higher taxonomy
coleop <- read_xlsx("data/coleop.comp.final_20220831.xlsx", 
                    sheet = "Sheet1") %>%
  rename(final_ID = 'species_list:db_v05.c') %>%
  filter(`percent similarity` >= 90,
         count >= 10) %>%
  left_join(famlookup, by = "final_ID") %>%
  select(kingdom, phylum, class, order, family, 
         final_ID, starts_with("sample")) %>%
  mutate(primer = "coleop") %>%
  select(primer, phylum, class, order, family,
         final_ID, starts_with("sample")) %>%
  arrange(primer, phylum, class, order, family, final_ID)

# check for missed family-level arthropods in coleop dataset
    # view this object and scan final_ID's with both family & order==NA
    # should be only those not identified to order
    # if "final_lowest" is family, then it was not read right by taxize
coleop_check <- coleop %>% 
  filter(is.na(order)==T | order == "NA") %>%
  filter(family == "NA" | is.na(family)==T)
rm(coleop_check)

# read in OTU data for Zeale primer set
zeale <- read_xlsx("data/zeale.comp.final_fixtaxonID.xlsx", 
                   sheet ="Sheet1") %>%
  rename(final_ID = taxonID) %>%
  filter(count >= 10) %>%
  left_join(famlookup, by = "final_ID") %>%
  select(kingdom, phylum, class, order, family,
         final_ID, starts_with("sample")) %>%
  mutate(primer = "zeale") %>%
  select(primer, phylum, class, order, family, 
         final_ID, starts_with("sample")) %>%
  arrange(primer, phylum, class, order, family, final_ID)

# check for missed arthropods in zeale dataset
    # view this object and scan final_ID's with family == NA
zeale_check <- zeale %>% 
  filter(is.na(order)==T | order == "NA") %>%
  filter(family == "NA" | is.na(family)==T)
rm(zeale_check)

# combine data sets
data_full <- zeale %>%
  bind_rows(coleop)

# reads data just for arthropods
art_full <- data_full %>%
  filter(phylum == "Arthropoda") %>%
  group_by(primer, family) %>%
  mutate(otu_id = paste0(family,"_", primer, "_", 1:length(primer))) %>%
  ungroup() %>%
  mutate(lineage = paste0("r__Root (Arthropoda);c__", 
                          class, ";o__", order, ";f__", family),
         lineage_order = paste0("r__Root (Arthropoda);c__", 
                          class, ";o__", order))

art_order <- art_full %>%
  filter(order != "NA" & is.na(order)==F)

art <- art_full %>%
  filter(family != "NA" & is.na(family)==F)

# make family-lineage lookup table
lineage_lookup <- art %>%
  dplyr::select(family, lineage) %>%
  distinct()

# otu count by family for arthropods (both primers separate)
n_otus_primer <- art %>%
  select(primer, lineage, starts_with("sample")) %>%
  mutate(across(.cols = starts_with("sample"), 
                .fns = function(x) ifelse(x > 0, 1, 0))) %>%
  group_by(primer, lineage) %>%
  summarise(across(starts_with("sample"), sum),
            .groups = "drop")

# otu count by family for arthropods (max of 2 primers)
n_otus_max <- n_otus_primer %>%
  group_by(lineage) %>%
  # max number of OTUs detected by either primer set
  summarise(across(starts_with("sample"), max))

# rename columns
new_col_names <- n_otus_max %>% 
  select(starts_with("sample")) %>%
  colnames() %>%
  substr(., 1, 11) %>%
  gsub(., pattern = ":", replacement = "")

colnames(n_otus_max) <- c("lineage", new_col_names)

# family presence/absence for arthropods (both primers combined)
pa_fam <- n_otus_max %>%
  mutate(across(starts_with("sample"),
                .fns = function(x) ifelse(x > 0,1,0)))

# separate family presence/absence into spray & roller matrices
pa_fam_s <- pa_fam %>%
  select(contains("eS")) %>%
  as.matrix()

pa_fam_r <- pa_fam %>%
  select(contains("eR")) %>%
  as.matrix()

pa_fam_soil <- pa_fam %>%
  select(contains("eD")) %>%
  as.matrix()

pa_fam_w <- pa_fam %>%
  select(contains("eW")) %>%
  as.matrix()

# pa_fam_array <- array(NA, dim = c(86, 20, 2))
# pa_fam_array[,,1] <- pa_fam_s
# pa_fam_array[,,2] <- pa_fam_r
# pa_fam_both <- apply(pa_fam_array, c(1,2), max)

# make a data frame of prevalence of each family by method
# pasum <- data.frame(
#   lineage = pa_fam$lineage,
#   spray.pa = apply(pa_fam_s, 1, mean),
#   roll.pa = apply(pa_fam_r, 1, mean),
#   both.pa = apply(pa_fam_both, 1, mean)) %>%
#   arrange(desc(roll.pa)) %>%
#   mutate(roll.rank = 1:length(roll.pa)) %>%
#   arrange(desc(spray.pa)) %>%
#   mutate(spray.rank = 1:length(spray.pa)) %>%
#   mutate(whichdet = case_when(roll.pa > 0 & spray.pa > 0 ~ 0,
#                               roll.pa > 0 & spray.pa == 0 ~ 1,
#                               roll.pa == 0 & spray.pa > 0 ~ -1))

d_samples <- data.frame(sample_id = colnames(pa_fam)[2:14]) %>%
  mutate(Method = stringr::str_sub(sample_id, -2,-2),
         Samp = sample_id)
```
# Count up families by method and make Venn diagram
```{r}
# subdivide 'art' into columns by sampling method for counting
art_spray <- art %>%
  select(family, contains(c("S3", "S4", "S5"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(family) %>%
  distinct() # 67 families with spray

art_roll <- art %>%
  select(family, contains(c(":R"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(family) %>%
  distinct() # 71 families with roll

art_water <- art %>%
  select(family, contains(c(":W"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(family) %>%
  distinct() # 53 families with water

art_soil <- art %>%
  select(family, contains(c(":D"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(family) %>%
  distinct() # 38 families with soil

# unique families within each method
(spray_unique <- art_spray %>%
  filter(family %notin% unique(c(art_roll$family, 
                           art_water$family,
                           art_soil$family)))) # 3 unique

(roll_unique <- art_roll %>%
  filter(family %notin% unique(c(art_spray$family, 
                           art_water$family,
                           art_soil$family)))) # 10 unique

(water_unique <- art_water %>%
  filter(family %notin% unique(c(art_spray$family, 
                           art_roll$family,
                           art_soil$family)))) # 2 unique

(soil_unique <- art_soil %>%
  filter(family %notin% unique(c(art_spray$family, 
                           art_roll$family,
                           art_water$family)))) # 4 unique

# Venn diagram of the 4 methods
# code from: https://www.datanovia.com/en/blog/venn-diagram-with-r-or-rstudio-a-million-ways/
# devtools::install_github("yanlinlin82/ggvenn")

venn_methods <- list(
  Soil = art_soil$family,
  Water = art_water$family,
  Spray = art_spray$family,
  Roller = art_roll$family
)

library(ggvenn)
ggvenn(
  venn_methods, 
  fill_color = c("#EFC000FF", "#868686FF", "#CD534CFF", "#0073C2FF"),
  # blue, yellow, gray, red
  stroke_size = 0.6, set_name_size = 5,
  text_size = 3
  )

ggsave("figures/venn3.jpg", height = 6, width = 6, dpi = 400)

# pairwise overlap (manually counted from Venn diagram)
# spray-roller: 58 overlapping of 80 total (73% overlap)
# water-roller: 49 overlapping of 75 total (65% overlap)
# soil-roller: 28 overlapping of 81 total (35% overlap)
# water-spray: 48 overlapping of 72 total (67% overlap)
# soil-spray: 34 overlapping of 71 total (48% overlap)
# soil-water: 27 overlapping of 64 total (42% overlap)

# how many families not detected by roller/spray in both studies
art_water %>%
  bind_rows(art_soil) %>%
  distinct() %>%
  # families 1-177 are from the roller/spray 'primary study'
  filter(family %notin% unique(c(size$family[1:177], 
                          art_spray$family,
                          art_roll$family)))

# answer: 3 (all of which were unique to soil)
# 1 Trogidae     (hide beetles)
# 2 Keroplatidae (fungus gnats)
# 3 Nycteribiidae (bat flies)

rm(art_spray, art_water, art_roll, art_soil,
   soil_unique, spray_unique, roll_unique, water_unique,
   venn_methods)
```
# Make Table S1
```{r}
# subdivide 'art' into columns by sampling method for counting
art_spray <- art %>%
  select(class, order, family, contains(c("S3", "S4", "S5"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(class, order, family) %>%
  distinct() %>%
  arrange(class, order, family) %>%
  mutate(method = "Spray")

art_roll <- art %>%
  select(class, order, family, family, contains(c(":R"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(class, order, family) %>%
  distinct() %>%
  arrange(class, order, family) %>%
  mutate(method = "Roller")

art_water <- art %>%
  select(class, order, family, family, contains(c(":W"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(class, order, family) %>%
  distinct() %>%
  arrange(class, order, family) %>%
  mutate(method = "Water")

art_soil <- art %>%
  select(class, order, family, family, contains(c(":D"))) %>%
   mutate(sum = rowSums(across(where(is.numeric)))) %>%
  filter(sum > 0) %>%
  select(class, order, family) %>%
  distinct() %>%
  arrange(class, order, family) %>%
  mutate(method = "Soil")

tab <- art_roll %>%
  bind_rows(art_spray, art_soil, art_water) %>%
  mutate(value = 1) %>%
  tidyr:: pivot_wider(id_cols = class:family,
                      values_from = value,
                      names_from = method) %>%
  arrange(class, order, family)
tab[is.na(tab)] <- 0

library(kableExtra)
 tables1 <- tab %>%
  kbl(caption = "A good title") %>%
  kable_classic(full_width = F, html_font = "Cambria")


# save the table to HTML file
save_kable(tables1,
           "figures/TableS1_substrate_compare_families.html")

rm(art_spray, art_water, art_roll, art_soil, tab, tables1)

```
# Format data for heat trees
```{r}
library(taxa)
obj <- parse_tax_data(n_otus_max,
                      class_cols = "lineage", 
                      class_sep = ";", 
                      class_regex = "^(.+)__(.+)$", # Regex 
                      class_key = c(tax_rank = "info", 
                                    # key describing each regex group
                                    tax_name = "taxon_name"))

# convert to proportions
# obj$data$tax_data <- calc_obs_props(obj, "tax_data")

#Getting per-taxon information
obj$data$tax_abund <- calc_taxon_abund(obj, "tax_data",
                                       cols = d_samples$sample_id,
                                       groups = d_samples$Method)

# change column names
obj$data$tax_abund$Soil <- obj$data$tax_abund$D
obj$data$tax_abund$Water <- obj$data$tax_abund$W
obj$data$tax_abund$Roller <- obj$data$tax_abund$R
obj$data$tax_abund$Spray <- obj$data$tax_abund$S

obj$data$tax_abund$Soil_per <- obj$data$tax_abund$Soil/5
obj$data$tax_abund$Roller_per <- obj$data$tax_abund$Roller/3
obj$data$tax_abund$Spray_per <- obj$data$tax_abund$Spray/3
obj$data$tax_abund$Water_per <- obj$data$tax_abund$Water/2

#Getting per-taxon information for 'number of samples'
obj$data$tax_abund1 <- calc_taxon_abund(obj, "tax_data",
                                       cols = d_samples$sample_id)

# calculate the number of samples that have reads for each taxon
obj$data$tax_occ <- calc_n_samples(obj, "tax_abund1", groups = d_samples$Method, cols = d_samples$sample_id)

# change column names
obj$data$tax_occ$Soil <- obj$data$tax_occ$D
obj$data$tax_occ$Water <- obj$data$tax_occ$W
obj$data$tax_occ$Spray <- obj$data$tax_occ$S
obj$data$tax_occ$Roller <- obj$data$tax_occ$R


# calculate the number of methods that detected each taxon
obj$data$tax_occ$num_methods <- (obj$data$tax_occ$Soil>0) +
  (obj$data$tax_occ$Roller>0) +
  (obj$data$tax_occ$Spray>0) +
  (obj$data$tax_occ$Water>0)

# calculate mean number of taxa per sample detected across all methods
obj$data$tax_abund$All_per <- (obj$data$tax_abund$Soil_per +
  obj$data$tax_abund$Roller_per + 
  obj$data$tax_abund$Spray_per +
  obj$data$tax_abund$Water_per)/4

# calculate mean number of taxa detected across all methods
obj$data$tax_abund$All <- (obj$data$tax_abund$Soil +
  obj$data$tax_abund$Roller + 
  obj$data$tax_abund$Spray +
  obj$data$tax_abund$Water)/4
```
# Make heat trees (4-method)
```{r}
# Soil
set.seed(1) # This makes the plot appear the same each time it is run 
(soil <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = obj$data$tax_abund$Soil,
          node_color = obj$data$tax_occ$Soil, 
          node_color_digits = 2,
          node_color_trans = "linear",
          node_color_interval = c(0,5),
          node_size_axis_label = "No. MOTUs",
          node_color_axis_label = "Samples with reads",
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford") +
    theme(plot.margin=unit(c(-1,0,-1,0), "cm")) +
    annotate(geom = "text", x = .9, y = .9, label = "Soil", size = 9)
  )
 # ggsave("figures/Soil_tree_abund2_margin.jpg", 
        # width = 7, height = 7, dpi = 400)

# Roller
set.seed(1) # This makes the plot appear the same each time it is run 
(roller <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = obj$data$tax_abund$Roller,
          node_color = obj$data$tax_occ$Roller,
          node_color_digits = 2,
          node_color_trans = "linear",
          node_color_interval = c(0,3),
          node_size_axis_label = "No. MOTUs",
          node_color_axis_label = "Samples with reads",
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford") %>%
  + theme(plot.margin=unit(c(-1,0,-1,0), "cm")) +
    annotate(geom = "text", x = .9, y = .9, label = "Roller", size = 9)
  )
# ggsave("figures/Roller_tree_abund2_margin.jpg", width = 7, height = 7, dpi = 400)

# Spray
set.seed(1) # This makes the plot appear the same each time it is run 
(spray <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = obj$data$tax_abund$Spray,
          node_color = obj$data$tax_occ$Spray,
          node_color_digits = 1,
          node_color_trans = "linear",
          node_color_interval = c(0,3),
          node_size_axis_label = "No. MOTUs",
          node_color_axis_label = "Samples with reads",
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford") %>%
  + theme(plot.margin=unit(c(-1,0,-1,0), "cm")) +
    annotate(geom = "text", x = .9, y = .9, label = "Spray", size = 9)
  )
# ggsave("figures/Spray_tree_abund2_margin.jpg", width = 7, height = 7, dpi = 400)

# Water
set.seed(1) # This makes the plot appear the same each time it is run 
(water <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = obj$data$tax_abund$Water,
          node_color = obj$data$tax_occ$Water,
          node_color_digits = 1,
          node_color_trans = "linear",
          node_color_interval = c(0,2),
          node_size_axis_label = "No. MOTUs",
          node_color_axis_label = "Samples with reads",
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford") %>%
  + theme(plot.margin=unit(c(-1,0,-1,0), "cm")) +
    annotate(geom = "text", x = .9, y = .9, label = "Water", size = 9) 
)
# ggsave("figures/Water_tree_abund2_margin.jpg", width = 7, height = 7, dpi = 400)

# 4-panel figure
g <- gridExtra::grid.arrange(roller, spray, soil, water)

ggsave("figures/FigS3_heat_tree_collage_grid.jpg", g, 
       height = 9, width = 9, dpi = 400)
```
# Make heat tree showing number of methods that detected each taxa
```{r}
set.seed(1) # This makes the plot appear the same each time it is run 
(methods <- heat_tree(obj, 
          node_label = taxon_names,
          node_size = obj$data$tax_abund$All,
          node_color = obj$data$tax_occ$num_methods, 
          node_size_axis_label = "Mean no. MOTUs",
          node_color_axis_label = "No. methods with reads",
          node_color_range = c("gray", "darkgoldenrod1", "steelblue"),
          layout = "davidson-harel", # The primary layout algorithm
          initial_layout = "reingold-tilford")) # The layout algorithm 
# ggsave("figures/FigS2_number_of_methods_tree.jpg", width = 7, height = 7, dpi = 400)
```


# Accumulation curves
used code from here: https://rpubs.com/Roeland-KINDT/694021
and: http://biological-complexity.blogspot.com/2018/01/on-species-accumulation-curves.html
```{r}
# format data matrices
spray_mat <- pa_fam_s %>%
  t()
spray_mat[spray_mat>0] <- 1 

roll_mat <- pa_fam_r %>%
  t()
roll_mat[roll_mat>0] <- 1 

soil_mat <- pa_fam_soil %>%
  t()
soil_mat[soil_mat>0] <- 1 

water_mat <- pa_fam_w %>%
  t()
water_mat[water_mat>0] <- 1 


# calculate accumulation curves
accum.spray <- accumcomp(spray_mat, 
                     y=data.frame(method = rep("spray", 
                                               nrow(spray_mat))),
                     factor='method', 
  method='exact', conditioned=FALSE, plotit=FALSE)
accum.spray

accum.roll <- accumcomp(roll_mat, 
                     y=data.frame(method = rep("roll", 
                                               nrow(roll_mat))),
                     factor='method', 
  method='exact', conditioned=FALSE, plotit=FALSE)
accum.roll

accum.soil <- accumcomp(soil_mat, 
                     y=data.frame(method = rep("soil", 
                                               nrow(soil_mat))),
                     factor='method', 
  method='exact', conditioned=FALSE, plotit=FALSE)
accum.soil

accum.water <- accumcomp(water_mat, 
                     y=data.frame(method = rep("water", 
                                               nrow(water_mat))),
                     factor='method', 
  method='exact', conditioned=FALSE, plotit=FALSE)
accum.water

# format accumulation curve data for plotting
plot.data.spray <- data.frame(samples = c(accum.spray[,,1]), 
           s = c(accum.spray[,,2]), 
           sd = c(accum.spray[,,3]),
           method = "Spray")

plot.data.roll <- data.frame(samples = c(accum.roll[,,1]), 
           s = c(accum.roll[,,2]), 
           sd = c(accum.roll[,,3]),
           method = "Roller")

plot.data.soil <- data.frame(samples = c(accum.soil[,,1]), 
           s = c(accum.soil[,,2]), 
           sd = c(accum.soil[,,3]),
           method = "Soil")

plot.data.water <- data.frame(samples = c(accum.water[,,1]), 
           s = c(accum.water[,,2]), 
           sd = c(accum.water[,,3]),
           method = "Water")

plot.data <- plot.data.spray %>%
  bind_rows(plot.data.roll) %>%
  bind_rows(plot.data.soil) %>%
  bind_rows(plot.data.water)

# c("#EFC000FF", "#868686FF", "#CD534CFF", "#0073C2FF"),
  # blue, yellow, gray, red

ggplot(plot.data) +
  geom_ribbon(aes(x = samples, ymin = s-2*sd, 
                  ymax = s+2*sd, fill = method),
              alpha = 0.5) +  
  geom_line(aes(x = samples, y = s, group = method), size = 1) +
  scale_fill_manual(values = c("steelblue", "#EFC000FF", 
                               "firebrick", "#868686FF"
                               )) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = c(0.85, 0.75)) +
  labs(x = "No. samples", y = "No. families", fill = "")


ggsave("figures/FigS4_substrate_compare_accum_curve.jpg",
       dpi = 600, width = 6, height = 4)
```
# NMDS Spray vs Roller, conifer vs. deciduous 
```{r}
# format data matrix
mds_data <- rbind(t(pa_fam_r),
                  t(pa_fam_s),
                  t(pa_fam_soil),
                  t(pa_fam_w))

# remove blank rows (none were blank, but keeping naming convention)
mds_data_nb <- mds_data

# format covariate data
env.data <- data.frame(method = str_sub(rownames(mds_data_nb), 
                                        -2, -2)) %>%
  mutate(method = case_when(method == "R" ~ "Roller",
                            method == "S" ~ "Spray",
                            method == "D" ~ "Soil",
                            method == "W" ~ "Water"))

# package vegan NMDS
set.seed(121)
arthNMDS = metaMDS(mds_data_nb,
                     k=3, distance = 'jaccard', trymax = 1000) 

plot1 <- ordiplot(arthNMDS, choices = c(1, 2))

### NOTE: warning message about insufficient data 
  # and plot does not make sense
# Warning message:
# In metaMDS(mds_data_nb, k = 3, distance = "jaccard", trymax = 1000) :
#   stress is (nearly) zero: you may have insufficient data

# Test for differences among Methods 
  # (likely too few data points to be reliable)
# PERMANOVA
set.seed(12555)
perm_arth <- adonis(mds_data_nb ~ method, data = env.data, 
       permutations = 9999, method = "jaccard",
       strata = NULL, contr.unordered = "contr.sum",
       contr.ordered = "contr.poly")

perm_arth
```
# trait data - stacked bars
```{r}
feed_step1 <- diet %>%
  select(family, diet.cat2) %>%
  left_join(lineage_lookup) %>%
  right_join(n_otus_max) %>%
  group_by(diet.cat2) %>%
  # counts number of families with > 0 reads in each sample
  summarize(across(starts_with("sample"), 
                   .fns = function(x) sum(x > 0)),
            .groups = "drop")

feedcats <- feed_step1$diet.cat2
feed <- feed_step1 %>%
  select(starts_with("sample")) %>%
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  mutate(sample_id = colnames(feed_step1)[2:14],
         method = str_sub(sample_id, -2,-2)) %>%
  group_by(method) %>%
  # calculates mean number of families in samples of each group
  summarize(across(contains("V"), mean),
            .groups = "drop")
colnames(feed) <- c("method", feedcats)
rm(feed_step1, feedcats)

feed_df <- feed %>% 
  pivot_longer(., cols = 2:7) %>%
  mutate(method = case_when(method == "R" ~ "Roller",
                          method == "S" ~ "Spray",
                          method == "D" ~ "Soil",
                          method == "W" ~ "Water"),
         order = case_when(name == "Predator" ~ 1,
                           name == "Parasite/parasitoid" ~ 2,
                           name == "Phytophagous" ~ 3,
                           name == "Scavenger" ~ 4,
                           name == "Mycetophagous" ~ 5,
                           name == "Multiple categories" ~ 6),
         diet.cat2 = fct_reorder(name, order)
         )
  
(feed_plot <- 
  ggplot(data = feed_df, 
       aes(x = method, y = value, fill = name)) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete=TRUE) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "% of families", x = "", 
       fill = "") +
  ggtitle("Feeding Guild") +
  theme(axis.text.x = element_text(size = 15))
)

# ggsave("figures/PlotG_feeding_guild_condensed.jpg", 
#        width = 6, height = 4, dpi = 400)

# Habitat / life mode
life_step1 <- lifemode %>%
  select(family, life.cat) %>%
  left_join(lineage_lookup) %>%
  right_join(n_otus_max) %>%
  group_by(life.cat) %>%
  summarize(across(starts_with("sample"), 
                   .fns = function(x) sum(x > 0)),
            .groups = "drop")

lifecats <- life_step1$life.cat
life <- life_step1 %>%
  select(starts_with("sample")) %>%
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  mutate(sample_id = colnames(life_step1)[2:14],
         method = str_sub(sample_id, -2,-2)) %>%
  group_by(method) %>%
  summarize(across(contains("V"), mean),
            .groups = "drop")
colnames(life) <- c("method", lifecats)
rm(life_step1, lifecats)

life_df <- life %>% 
  pivot_longer(., cols = starts_with("All"):starts_with("Some")) %>%
  mutate(method = case_when(method == "R" ~ "Roller",
                          method == "S" ~ "Spray",
                          method == "D" ~ "Soil",
                          method == "W" ~ "Water"),
         order = case_when(name == "Fully aquatic" ~ 4,
                           name == "Fully terrestrial" ~ 1,
                           name == "All larvae aquatic" ~ 3,
                           name == "Some larvae aquatic" ~ 2),
         name = fct_reorder(name, order, .desc = F))
  
(life_plot <- 
  ggplot(data = life_df, 
       aes(x = method, y = value, fill = name)) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete=TRUE) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "% of families", x = "", 
       fill = "") +
  ggtitle("Life mode") +
  theme(axis.text.x = element_text(size = 15))
)

# ggsave("figures/PlotI_life_mode.jpg",
#        width = 6, height = 4, dpi = 400)

# Body size
size_step1 <- size %>%
  select(family, size.cat = Body_Size, order = Body_Size_order) %>%
  left_join(lineage_lookup) %>%
  right_join(n_otus_max) %>%
  group_by(size.cat) %>%
  summarize(across(starts_with("sample"), 
                   .fns = function(x) sum(x > 0)),
            .groups = "drop")

sizecats <- size_step1$size.cat
size_step2 <- size_step1 %>%
  select(starts_with("sample")) %>%
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  mutate(sample_id = colnames(size_step1)[2:14],
         method = str_sub(sample_id, -2,-2)) %>%
  group_by(method) %>%
  summarize(across(contains("V"), mean),
            .groups = "drop")
colnames(size_step2) <- c("method", sizecats)
rm(size_step1, sizecats)

size_df <- size_step2 %>% 
  pivot_longer(., cols = 2:5) %>%
  mutate(method = case_when(method == "R" ~ "Roller",
                          method == "S" ~ "Spray",
                          method == "D" ~ "Soil",
                          method == "W" ~ "Water")) %>%
  left_join(distinct(select(size, name = Body_Size, 
                            order = Body_Size_order))) %>%
  mutate(name = fct_reorder(name, order, .desc = F))
  
(size_plot <- 
  ggplot(data = size_df, 
       aes(x = method, y = value, fill = name)) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete=TRUE) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "% of families", x = "", 
       fill = "") +
  ggtitle("Body size") +
  theme(axis.text.x = element_text(size = 15))
)

# ggsave("figures/PlotJ_body_size.jpg", 
#        width = 6, height = 4, dpi = 400)

#################
##### combine feeding guild, life mode, and body size plots
#################

feed_plot / life_plot / size_plot

ggsave("figures/FigS5_sub_compare_guilds_bar.jpg", 
       width = 6, height = 12, dpi = 400)

```
# multinomial models for feeding guild data
https://discourse.mc-stan.org/t/example-with-family-multinomial/8707
https://discourse.mc-stan.org/t/interpret-parameters-from-multinomial-categorical-logit-regression/26374
```{r}
n_otus_pa <- n_otus_max[,-1]
n_otus_pa[n_otus_pa > 0] <- 1
n_otus_pa <- cbind(n_otus_max[,1], n_otus_pa)

feed_freq <- n_otus_pa %>%
  left_join(lineage_lookup) %>%
  left_join(select(diet, family, diet.cat2)) %>%
  select(-family, -lineage)

feed_freq_sum1 <- aggregate(feed_freq[,1:13], 
                           by = list(feed_freq$diet.cat2), sum)

feed_freq_sum2 <- feed_freq_sum1 %>%
  select(2:14) %>%
  t()
colnames(feed_freq_sum2) <- feed_freq_sum1$Group.1

feed_freq_sum <- feed_freq_sum2 %>%
  as.data.frame() %>%
  mutate(sample = rownames(feed_freq_sum2),
         method = stringr::str_sub(sample, -2,-2)) %>%
  rename(mult = 1, myce = 2, para = 3, phyt = 4, pred = 5, scav = 6) %>%
  select(-sample)

library(brms)

dat <- feed_freq_sum
dat$size <- with(dat, mult + myce + para + phyt + pred + scav)
dat$y <- with(dat, cbind(mult, myce, para, phyt, pred, scav))

# model with method
set.seed(102)
fit.method <- brm(bf(y | trials(size) ~ method), 
            data = dat, family = multinomial(refcat = "mult"),
            save_pars = save_pars(all = TRUE), 
                          iter = 4000, warmup = 2000,
                          chains = 3, cores = 3)

# save model output so we don't have to refit each time
saveRDS(fit.method, "output/feed_multinomial_method_subcomp.rds")

# load the models so we don't have to refit them each time
fit.method <- readRDS("output/feed_multinomial_method_subcomp.rds")

```
# multinomial models for lifemode data
https://discourse.mc-stan.org/t/example-with-family-multinomial/8707
https://discourse.mc-stan.org/t/interpret-parameters-from-multinomial-categorical-logit-regression/26374
```{r}
n_otus_pa <- n_otus_max[,-1]
n_otus_pa[n_otus_pa > 0] <- 1
n_otus_pa <- cbind(n_otus_max[,1], n_otus_pa)

life_freq <- n_otus_pa %>%
  left_join(lineage_lookup) %>%
  left_join(select(lifemode, family, life.cat)) %>%
  select(-family, -lineage)

life_freq_sum1 <- aggregate(life_freq[,1:13], 
                           by = list(life_freq$life.cat), sum)

life_freq_sum2 <- life_freq_sum1 %>%
  select(2:14) %>%
  t()
colnames(life_freq_sum2) <- life_freq_sum1$Group.1

life_freq_sum <- life_freq_sum2 %>%
  as.data.frame() %>%
  mutate(sample = rownames(life_freq_sum2),
         method = stringr::str_sub(sample, -2,-2)) %>%
  rename(aqlar = 1, fullter = 2, 
         someaq = 3) %>%
  select(-sample)

library(brms)

dat <- life_freq_sum
dat$size <- with(dat, aqlar + fullter + someaq)
dat$y <- with(dat, cbind(aqlar, fullter, someaq))

# model with method
set.seed(102)
life.method <- brms::brm(bf(y | trials(size) ~ method), 
            data = dat, family = multinomial(refcat = "aqlar"),
            save_pars = save_pars(all = TRUE), 
                          iter = 4000, warmup = 2000,
                          chains = 3, cores = 3)

# save model output so we don't have to refit each time
saveRDS(life.method, "output/life_multinomial_method_subcomp.rds")

# load the models so we don't have to refit them each time
life.method <- readRDS("output/life_multinomial_method_subcomp.rds")

```
# multinomial models for size data
https://discourse.mc-stan.org/t/example-with-family-multinomial/8707
https://discourse.mc-stan.org/t/interpret-parameters-from-multinomial-categorical-logit-regression/26374
```{r}
n_otus_pa <- n_otus_max[,-1]
n_otus_pa[n_otus_pa > 0] <- 1
n_otus_pa <- cbind(n_otus_max[,1], n_otus_pa)

size_freq <- n_otus_pa %>%
  left_join(lineage_lookup) %>%
  left_join(select(size, family, size.cat = Body_Size)) %>%
  select(-family, -lineage)

size_freq_sum1 <- aggregate(size_freq[,1:13], 
                           by = list(size_freq$size.cat), sum)

size_freq_sum2 <- size_freq_sum1 %>%
  select(2:14) %>%
  t()
colnames(size_freq_sum2) <- size_freq_sum1$Group.1

size_freq_sum <- size_freq_sum2 %>%
  as.data.frame() %>%
  mutate(sample = rownames(size_freq_sum2),
         method = stringr::str_sub(sample, -2,-2)) %>%
  rename(vsmal = 1, vbig = 2, big = 3, 
         smal = 4) %>%
  select(-sample)

library(brms)

dat <- size_freq_sum
dat$size <- with(dat, vsmal + vbig + big + smal)
dat$y <- with(dat, cbind(vsmal, vbig, big, smal))

# model with method
set.seed(102)
size.method.tree <- brms::brm(bf(y | trials(size) ~ method), 
            data = dat, family = multinomial(refcat = "vsmal"),
            save_pars = save_pars(all = TRUE), 
                          iter = 4000, warmup = 2000,
                          chains = 3, cores = 3)

# save model output so we don't have to refit each time
saveRDS(size.method, "output/size_multinomial_method_subcomp.rds")

# load the models so we don't have to refit them each time
size.method <- readRDS("output/size_multinomial_method_subcomp.rds")
```
# Multinomial model plots (feeding, life mode, body size)
```{r}
### Feeding guild

# load the models so we don't have to refit them each time
fit.method <- readRDS("output/feed_multinomial_method_subcomp.rds")

# plot top model predictions
fit.newdata = expand.grid(method = c("S", "R", "D", "W"),
                                 size = 1)

fitsies <- fitted(fit.method, 
                  newdata = fit.newdata,probs = c(0.025, 0.1,
                                                  0.9, 0.975))

fitsies

fitsies.list <- list()
for(i in 1:dim(fitsies)[3]){
  fitsies.list[[i]] <- fitsies[,,i]
}

fits_df <- do.call(rbind, fitsies.list) %>%
  as.data.frame() %>%
  mutate(method = rep(fit.newdata$method, 6),
         feed = c(rep("Mulitple categories", 4),
                  rep("Mycetophagous", 4),
                  rep("Parasite/Parasitoid", 4),
                  rep("Phytophagous", 4),
                  rep("Predator", 4),
                  rep("Scavenger", 4))) %>%
  group_by(feed) %>%
  mutate(mean_p = mean(Estimate)) %>%
  ungroup() %>%
  mutate(feed = fct_reorder(feed, mean_p),
         method = case_when(method == "S" ~ "Spray",
                            method == "R" ~ "Roller",
                            method == "D" ~ "Soil",
                            method == "W" ~ "Water"))
         
(
  feed_plot2 <- 
fits_df %>%
  ggplot() +
  geom_point(aes(y = feed, x = 100*Estimate, color = method, 
                 group = method),
             position = position_dodge(width = .75),
             size = 3) +
  geom_errorbar(aes(y = feed, xmin = 100*Q10, 
                    xmax = 100*Q90, color = method,
                    group = method),
                size = 1,
                position = position_dodge(width = .75),
                width = 0) +
  geom_errorbar(aes(y = feed, xmin = 100*Q2.5, 
                    xmax = 100*Q97.5, color = method,
                    group = method),
                position = position_dodge(width = .75),
                width = 0) +
  scale_color_manual(values = c("steelblue", "orange",
                                "firebrick", "darkgray")) +
  labs(color = "",
       y = "",
       x = "% of families",
       title = "Feeding guild") +
  theme_bw() +
  theme(text = element_text(size = 13),
        legend.position = c(.8,.25))
)

### Life mode

# load the models so we don't have to refit them each time
life.method <- readRDS("output/life_multinomial_method_subcomp.rds")

# plot top model predictions
fit.newdata = expand.grid(method = c("S", "R", "D", "W"),
                                 size = 1)

fitsies <- fitted(life.method, 
                  newdata = fit.newdata,probs = c(0.025, 0.1,
                                                  0.9, 0.975))

fitsies

fitsies.list <- list()
for(i in 1:dim(fitsies)[3]){
  fitsies.list[[i]] <- fitsies[,,i]
}

life_fits_df <- do.call(rbind, fitsies.list) %>%
  as.data.frame() %>%
  mutate(method = rep(fit.newdata$method, 3),
         life = c(rep("All larvae aquatic", 4),
                  rep("Fully terrestrial", 4),
                  rep("Some larvae aquatic", 4))) %>%
  group_by(life) %>%
  mutate(mean_p = mean(Estimate)) %>%
  ungroup() %>%
  mutate(life = fct_reorder(life, mean_p),
         method = case_when(method == "S" ~ "Spray",
                            method == "R" ~ "Roller",
                            method == "D" ~ "Soil",
                            method == "W" ~ "Water"))
         
(life_plot2 <- 
life_fits_df %>%
  ggplot() +
  geom_point(aes(y = life, x = 100*Estimate, color = method, 
                 group = method),
             position = position_dodge(width = .75),
             size = 3) +
  geom_errorbar(aes(y = life, xmin = 100*Q10, 
                    xmax = 100*Q90, color = method,
                    group = method),
                size = 1,
                position = position_dodge(width = .75),
                width = 0) +
  geom_errorbar(aes(y = life, xmin = 100*Q2.5, 
                    xmax = 100*Q97.5, color = method,
                    group = method),
                position = position_dodge(width = .75),
                width = 0) +
  scale_color_manual(values = c("steelblue", "orange",
                                "firebrick", "darkgray")) +
  labs(color = "",
       y = "",
       x = "% of families",
       title = "Life mode") +
  theme_bw() +
  theme(text = element_text(size = 13),
        legend.position = c(.8,.25))
)

### Body size

# load the models so we don't have to refit them each time
size.method <- readRDS("output/size_multinomial_method_subcomp.rds")

# plot top model predictions
fit.newdata = expand.grid(method = c("S", "R", "D", "W"),
                                 size = 1)

fitsies <- fitted(size.method, 
                  newdata = fit.newdata,probs = c(0.025, 0.1,
                                                  0.9, 0.975))

fitsies

fitsies.list <- list()
for(i in 1:dim(fitsies)[3]){
  fitsies.list[[i]] <- fitsies[,,i]
}

size_fits_df <- do.call(rbind, fitsies.list) %>%
  as.data.frame() %>%
  mutate(method = rep(fit.newdata$method, 4),
         size = c(rep("< 5 mm", 4),
                  rep("> 20 mm", 4),
                  rep("10-20 mm", 4),
                  rep("5-10 mm", 4))) %>%
  group_by(size) %>%
  mutate(mean_p = mean(Estimate)) %>%
  ungroup() %>%
  mutate(size = fct_reorder(size, mean_p),
         method = case_when(method == "S" ~ "Spray",
                            method == "R" ~ "Roller",
                            method == "D" ~ "Soil",
                            method == "W" ~ "Water"))
         
(size_plot2 <- 
size_fits_df %>%
  ggplot() +
  geom_point(aes(y = size, x = 100*Estimate, color = method, 
                 group = method),
             position = position_dodge(width = .5),
             size = 3) +
  geom_errorbar(aes(y = size, xmin = 100*Q10, 
                    xmax = 100*Q90, color = method,
                    group = method),
                size = 1,
                position = position_dodge(width = .5),
                width = 0) +
  geom_errorbar(aes(y = size, xmin = 100*Q2.5, 
                    xmax = 100*Q97.5, color = method,
                    group = method),
                position = position_dodge(width = .5),
                width = 0) +
  scale_color_manual(values = c("steelblue", "orange",
                                "firebrick", "darkgray")) +
  labs(color = "",
       y = "",
       x = "% of families",
       title = "Body size") +
  theme_bw() +
  theme(text = element_text(size = 13),
        legend.position = c(.8,.25))
)

### Combine all 3 plots with patchwork
feed_plot2 / life_plot2 / size_plot2

ggsave("figures/FigS5_sub_compare_guilds_multinom2.jpg", 
       width = 5, height = 12, dpi = 400)

 ### Combine all 3 plots with patchwork
feed_plot2 + size_plot2 + life_plot2 + plot_layout(ncol = 2)

ggsave("figures/FigS5_sub_compare_guilds_multinom3.jpg", 
       width = 9, height = 8, dpi = 400)
```


# Plot relative abundance of orders by method (both primers combined)
% of samples detected
NOT UPDATED FOR 4-METHOD (SUBSTRATE COMPARISON) STUDY
```{r}
#################
#### Plotting relative abundance of each order by method (bar chart)
#### (% of samples detected)
#################

# # make a pres/abs dataframe of families by order for each sample
# n_otus_pa <- n_otus_max[,-1]
# n_otus_pa[n_otus_pa > 0] <- 1
# order_pa <- cbind(n_otus_max[,1], n_otus_pa) %>%
#   full_join(lineage_lookup) %>%
#   left_join(distinct(select(famlookup, family, order))) %>%
#   select(-family, -lineage)
# 
# # condense that into count of familes by order (roller)
# order_freq_roll <- aggregate(order_pa[,1:13], 
#                            by = list(order_pa$order), sum) %>%
#   select(order = Group.1, contains("eR"))
# 
# # get a vector of the orders
# order_vector <- order_freq_roll$order
# 
# # convert family count data into presence absence of each order (roller)
# order_freq_roll[order_freq_roll>0] <- 1
# order_freq_roll <- order_freq_roll %>% 
#   select(-order) # remove messed up order col 
# 
# # condense pres/abs into count of familes by order (spray)
# order_freq_spray <- aggregate(order_pa[,1:13], 
#                            by = list(order_pa$order), sum) %>%
#   select(order = Group.1, contains("eS"))
# 
# # convert family count data into presence absence of each order (spray)
# order_freq_spray[order_freq_spray>0] <- 1
# order_freq_spray <- order_freq_spray %>% 
#   select(-order) # remove messed up order col 
# 
# # count samples with at least one detection of each order
# order_samps_roll <- data.frame(order = order_vector,
#                           count = apply(order_freq_roll, 1, sum)) %>%
#   mutate(method = "Roller")
# 
# order_samps_spray <- data.frame(order = order_vector,
#                           count = apply(order_freq_spray, 1, sum)) %>%
#   mutate(method = "Spray")
# 
# # set up plotting order df
# order_df <- data.frame(cat = unique(paste0(art_order$class, "-", 
#                                       art_order$order)),
#                        order = unique(art_order$order),
#            # order2 = c(2,1,3,6,15,9,7,10,12,8,
#            #           14,13,11,22,16,5,20,19,17,21,18),
#           order2 = c(2,1,3,6, 14,7,8,11,13,10,15,12,9,
#                      21,19,5,18,22,17,20,16),
#            name = c("Spiders",
#                     "Sarcoptiform mites",
#                     "Trombidiform mites",
#                     "Collembola",
#                     "Cockroaches",
#                     "Beetles",
#                     "Flies",
#                     "True bugs",
#                     "Bees, wasps, & ants",
#                     "Butterflies & moths",
#                     "Lacewings",
#                     "Crickets & grasshoppers",
#                     "Bark lice",
#                     "Fleas",
#                     "Caddisflies",
#                     "Centipedes",
#                     "Mayflies",
#                     "Mantids",
#                     "Dragonflies & damselflies",
#                     "Walking sticks",
#                     "Thrips")
#            )
#                  
# # bind final plotting dataframe
# order_samps <- order_samps_roll %>%
#   bind_rows(order_samps_spray) %>%
#   left_join(order_df) %>%
#   mutate(name = fct_reorder(name, order2, .desc = T)) %>%
#   group_by(order) %>%
#   mutate(mean_count = mean(count)) %>%
#   ungroup()
# 
# (
# who2_plot <- 
# order_samps %>%
#   ggplot() +
#   geom_col(aes(y = name, x = 100*(count/20),
#                fill = method),
#            position = position_dodge()) +
#   scale_fill_manual(values = c("steelblue", "firebrick")) +
#   scale_color_manual(values = c("steelblue", "firebrick")) +
#   theme_bw() +
#   theme(text = element_text(size = 14),
#         axis.text.y = element_text(size = 10),
#         legend.position = c(.7,.1)) +
#   labs(x = "% of samples",
#        y = "",
#        fill = "")
# )
# 
# # Stitch together primer plots
# library(patchwork) 
# 
# feed_mosaic <- feed_plot2 +
#   xlab("") +
#   guides(color = "none")
# 
# life_mosaic <- life_plot2 +
#   xlab("") +
#   guides(color = "none")
# 
# size_mosaic <- size_plot2 +
#   guides(color = "none")
# 
# patchobj <- (feed_mosaic / life_mosaic / size_mosaic) | who2_plot
# 
# ggsave("figures/order_compare3.png", width = 7, height = 7, dpi = 400)
```
# Plots of rarefied species richness, shannon & simpson indexes, relative read frequency by primer (substrate comparison study)
```{r}
# MOTU rarefied species richness by sample and primer set
names(art_order) # to get column numbers of matrix
data_cols <- 7:19
coleop_rare_mat <- art_full %>%
  filter(primer == "coleop") %>%
  select(data_cols) %>%
  as.matrix() %>%
  t() %>%
  as.data.frame()

zeale_rare_mat <- art_order %>%
  filter(primer == "zeale") %>%
  select(data_cols) %>%
  as.matrix() %>%
  t() %>%
  as.data.frame()

apply(coleop_rare_mat, 1, sum)
sort(apply(coleop_rare_mat, 1, sum))
apply(zeale_rare_mat, 1, sum)
sort(apply(zeale_rare_mat, 1, sum))

# get lowest number of reads
minreads <- 770

rarefy_coleop <- rarefy(coleop_rare_mat[,], minreads, se = T)
rarefy_zeale <- rarefy(zeale_rare_mat[,], minreads, se = T)

rarefy_coleop_df <- rarefy_coleop %>%
  t() %>%
  as.data.frame() %>%
  bind_cols(colnames(rarefy_coleop),.) %>%
  rename(sample = 1) %>%
  mutate(primer = "Coleop")

rarefy_zeale_df <- rarefy_zeale %>%
  t() %>%
  as.data.frame() %>%
  bind_cols(colnames(rarefy_zeale),.) %>%
  rename(sample = 1) %>%
  mutate(primer = "Zeale")

rarefy_df <- rarefy_coleop_df %>%
  bind_rows(rarefy_zeale_df)

rarefy_df_wide <- data.frame(
  sample = colnames(rarefy_coleop),
  coleop_S = rarefy_coleop[1,],
  zeale_S = rarefy_zeale[1,],
  coleop_se = rarefy_coleop[2,],
  zeale_se = rarefy_zeale[2,])

# now create a rarified version of the read matrixes for diversity metrics

coleop_rare_mat_rare <- rrarefy(coleop_rare_mat[,], minreads)
zeale_rare_mat_rare <- rrarefy(zeale_rare_mat[,], minreads)

# Calculate diversity metrics
coleop_rare_shannon <- diversity(coleop_rare_mat[,], 
                               index = "shannon", 
                               MARGIN = 1, base = exp(1)) %>%
  as.data.frame() %>%
  bind_cols(rownames(coleop_rare_mat[,]),.) %>%
  rename(sample = 1, coleop_shannon = 2)

zeale_rare_shannon <- diversity(zeale_rare_mat[,], 
                               index = "shannon", 
                               MARGIN = 1, base = exp(1)) %>%
  as.data.frame() %>%
  bind_cols(rownames(coleop_rare_mat[,]),.) %>%
  rename(sample = 1, zeale_shannon = 2)

shannon_df <- coleop_rare_shannon %>%
  bind_cols(select(zeale_rare_shannon, -sample))

# Calculate Simpsons index on rarefied data
coleop_rare_simpson <- diversity(coleop_rare_mat[,], 
                               index = "simpson") %>%
  as.data.frame() %>%
  bind_cols(rownames(coleop_rare_mat[,]),.) %>%
  rename(sample = 1, coleop_simpson = 2)

zeale_rare_simpson <- diversity(zeale_rare_mat[,], 
                               index = "simpson") %>%
  as.data.frame() %>%
  bind_cols(rownames(zeale_rare_mat[,]),.) %>%
  rename(sample = 1, zeale_simpson = 2)

simpson_df <- coleop_rare_simpson %>%
  bind_cols(select(zeale_rare_simpson, -sample))

# set font size for all plot annotations below
annfont <- 2
ytextsize = 10
xtextsize = 11

# Richness boxplots
rarefy_stats <- rarefy_df_wide %>%
  mutate(lc = log(coleop_S),
         lz = log(zeale_S)) %>%
  summarize(mean_lc = mean(lc),
            sd_lc = sd(lc),
            n_lc = length(lc),
            se_lc = sd_lc/sqrt(n_lc),
            lcl_lc = mean_lc - 2*se_lc,
            ucl_lc = mean_lc + 2*se_lc,
            mean_lz = mean(lz),
            sd_lz = sd(lz),
            n_lz = length(lz),
            se_lz = sd_lz/sqrt(n_lz),
            lcl_lz = mean_lz - 2*se_lz,
            ucl_lz = mean_lz + 2*se_lz)

exp(rarefy_stats)

(rareS.plot <- 
rarefy_df_wide %>%
  select(-ends_with("_se")) %>%
  tidyr::pivot_longer(cols = ends_with("_S")) %>%
  mutate(name = case_when(name == "coleop_S" ~ "Coleop",
                          name == "zeale_S" ~ "Zeale")) %>%
  ggplot(aes(x = name, y = value)) +
  geom_line(size = .5, alpha = .5, 
            aes(group = sample), 
            color = "darkgray") +
  geom_violin(draw_quantiles = .5, aes(fill = name),
              alpha = 0.6) +
  geom_point(size = 4, alpha = .5, aes(color = name)) +  scale_fill_manual(values = wes_palette("Cavalcanti1")) +
  scale_color_manual(values = wes_palette("Cavalcanti1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = ytextsize),
        axis.text.x = element_text(size = xtextsize)) +
  labs(x = "",
       y = "Rarefied MOTU richness") +
  guides(fill = "none", color = "none") +
  annotate("text", x = 2.5, y = 87, 
           label = paste0("Means (log-normal)",
           "\nColeop: ",
           round(exp(rarefy_stats$mean_lc),1), 
           ", 95% CI = [",
           round(exp(rarefy_stats$lcl_lc),1),
           ", ",
           round(exp(rarefy_stats$ucl_lc),1), 
           "]\n",
           "Zeale: ",
           round(exp(rarefy_stats$mean_lz),1),
           ", 95% CI = [",
           round(exp(rarefy_stats$lcl_lz),1),
           ", ",
           round(exp(rarefy_stats$ucl_lz),1),
           "]"),
           hjust = 1,
           vjust = 1,
           size = annfont,
           color = "darkgray")
)
  
# Evenness boxplots
simpson_stats <- simpson_df %>%
  mutate(lc = coleop_simpson,
         lz = zeale_simpson) %>%
  summarize(mean_lc = mean(lc),
            sd_lc = sd(lc),
            n_lc = length(lc),
            se_lc = sd_lc/sqrt(n_lc),
            lcl_lc = mean_lc - 2*se_lc,
            ucl_lc = mean_lc + 2*se_lc,
            mean_lz = mean(lz),
            sd_lz = sd(lz),
            n_lz = length(lz),
            se_lz = sd_lz/sqrt(n_lz),
            lcl_lz = mean_lz - 2*se_lz,
            ucl_lz = mean_lz + 2*se_lz)

simpson_stats

(simpson.plot <- 
simpson_df %>%
  tidyr::pivot_longer(cols = ends_with("_simpson")) %>%
  mutate(name = case_when(name == "coleop_simpson" ~ "Coleop",
                          name == "zeale_simpson" ~ "Zeale")) %>%
  ggplot(aes(x = name, y = value)) +
  geom_line(size = .5, alpha = .5, 
            aes(group = sample), 
            color = "darkgray") +
  geom_violin(draw_quantiles = .5, aes(fill = name),
              alpha = 0.6) +
  geom_point(size = 4, alpha = .5, aes(color = name)) +  scale_fill_manual(values = wes_palette("Cavalcanti1")) +
  scale_color_manual(values = wes_palette("Cavalcanti1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = ytextsize),
        axis.text.x = element_text(size = xtextsize)) +
  labs(x = "",
       y = "MOTU evenness (Simpson)") +
  guides(fill = "none", color = "none") +
  annotate("text", x = 2.5, y = 1.2,
           label = paste0("Means",
           "\nColeop: ",
           round(simpson_stats$mean_lc,2),
           ", 95% CI = [",
           round(simpson_stats$lcl_lc,2),
           ", ",
           round(simpson_stats$ucl_lc,2),
           "]\n",
           "Zeale: ",
           round(simpson_stats$mean_lz,2),
           ", 95% CI = [",
           round(simpson_stats$lcl_lz,2),
           ", ",
           round(simpson_stats$ucl_lz,2),
           "]"),
           hjust = 1,
           vjust = 1,
           size = annfont,
           color = "darkgray")
)
  
# Diversity boxplots
shannon_stats <- shannon_df %>%
  mutate(lc = coleop_shannon,
         lz = zeale_shannon) %>%
  summarize(mean_lc = mean(lc),
            sd_lc = sd(lc),
            n_lc = length(lc),
            se_lc = sd_lc/sqrt(n_lc),
            lcl_lc = mean_lc - 2*se_lc,
            ucl_lc = mean_lc + 2*se_lc,
            mean_lz = mean(lz),
            sd_lz = sd(lz),
            n_lz = length(lz),
            se_lz = sd_lz/sqrt(n_lz),
            lcl_lz = mean_lz - 2*se_lz,
            ucl_lz = mean_lz + 2*se_lz)

shannon_stats

(shannon.plot <- 
shannon_df %>%
  tidyr::pivot_longer(cols = ends_with("_shannon")) %>%
  mutate(name = case_when(name == "coleop_shannon" ~ "Coleop",
                          name == "zeale_shannon" ~ "Zeale")) %>%
  ggplot(aes(x = name, y = value)) +
  geom_line(size = .5, alpha = .5, 
            aes(group = sample), 
            color = "darkgray") +
  geom_violin(draw_quantiles = .5, aes(fill = name),
              alpha = 0.6) +
  geom_point(size = 4, alpha = .5, aes(color = name)) +  scale_fill_manual(values = wes_palette("Cavalcanti1")) +
  scale_color_manual(values = wes_palette("Cavalcanti1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = ytextsize),
        axis.text.x = element_text(size = xtextsize)) +
  labs(x = "",
       y = "MOTU diversity (Shannon)") +
  guides(fill = "none", color = "none") +
  annotate("text", x = 2.5, y = 4,
           label = paste0("Means",
           "\nColeop: ",
           round(shannon_stats$mean_lc,2),
           ", 95% CI = [",
           round(shannon_stats$lcl_lc,2),
           ", ",
           round(shannon_stats$ucl_lc,2),
           "]\n",
           "Zeale: ",
           round(shannon_stats$mean_lz,2),
           ", 95% CI = [",
           round(shannon_stats$lcl_lz,2),
           ", ",
           round(shannon_stats$ucl_lz,2),
           "]"),
           hjust = 1,
           vjust = 1,
           size = annfont,
           color = "darkgray")
)


#################
#### Plotting relative read abundance by order (bar chart)
#################

# note: create the order

# set up plotting order df
order_df <- data.frame(cat = unique(paste0(art_full$class, "-", 
                                      art_full$order)),
           order = c(3,1,2,5,8,6,12,11,7,
                     20,14,16,10,9,18,4,15,13,19,17,21),
           name = c("Spiders",
                    "Sarcoptiform mites",
                    "Trombidiform mites",
                    "Springtails (Entomobryo.)",
                    "Beetles",
                    "Flies",
                    "True bugs",
                    "Bees, wasps, & ants",
                    "Butterflies & moths",
                    "Unknown insects",
                    "Lacewings",
                    "Dragonflies & damselflies",
                    "Crickets & grasshoppers",
                    "Bark lice",
                    "Caddisflies",
                    "Springtails (Neelipleona)",
                    "Cockroaches",
                    "Mayflies",
                    "Dobsonflies & fishflies",
                    "Thrips",
                    "Unknown arthropods"))
                    
names(art_full)
primer_who <- art_full %>%
  mutate(cat = paste0(class, "-", order)) %>%
  select(primer, cat) %>%
  bind_cols(total.reads = rowSums(art_full[,7:19])) %>%
  group_by(primer, cat) %>%
  summarize(total.reads = sum(total.reads),
            .groups = "drop") %>%
  group_by(primer) %>%
  mutate(rel.reads = 100*total.reads / sum(total.reads)) %>%
  ungroup() %>%
  # this part adds primer-taxa categories that had no reads
  right_join(expand.grid(cat = unique(paste0(art_full$class, "-", 
                                      art_full$order)),
                         primer = c("coleop", "zeale"))) %>%
  # this part converts the NAs in the previous step to 0's
  mutate(rel.reads = tidyr::replace_na(rel.reads, 0),
         primer = case_when(primer == "coleop" ~ "Coleop",
                            primer == "zeale" ~ "Zeale")) %>%
  group_by(cat) %>%
  mutate(mean_rel.reads = mean(rel.reads)) %>%
  ungroup() %>%
  left_join(order_df) %>%
  mutate(name = forcats::fct_reorder(name, order, .desc = T))

(who_plot <- 
primer_who %>%
  ggplot() +
  geom_col(aes(y = name, x = sqrt(rel.reads),
               fill = primer),
           position = position_dodge(),
           alpha = 0.6) +
  scale_fill_manual(values = wes_palette("Cavalcanti1")) +
  scale_color_manual(values = wes_palette("Cavalcanti1")) +
  scale_x_continuous(breaks = c(0,2,4,6),
                     labels = c(0,4,16,36)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.y = element_text(size = 10),
        legend.position = c(.7,.1)) +
  labs(x = "% of total reads",
       y = "",
       fill = "")
)

# Stitch together primer plots
who_plot | (rareS.plot / simpson.plot / shannon.plot)

ggsave("figures/FigS2_primer_compare_subcomp3.png", 
       width = 7, height = 7, dpi = 400)
```