# Arthropod metabarcoding (4 methods)
Initial field effort testing 4 methods with n = 2-6 samples each.

# Load libraries. Read, clean and format data
```{r}
library(dplyr)
library(metacoder)
library(readxl)
library(ggplot2)
library(stringr)
library(taxa)
library(vegan)
library(BiodiversityR)
library(wesanderson)
library(patchwork)
library(tidyr)
library(forcats)
select <- dplyr::select
# path for taxonomy and ecology lookup tables
tax_data_path <- "data/arthropod.families_20220831.xlsx"
# note: the 20220816 version is up-to-date for 2methods
#   but hadn't received new families from 4methods yet

# read in family name look up 
    # will use to match each OTU with an NCBI family name
    # created by looking up each entry in NCBI if it didn't 
      # have a family name yet from bioinformatics work
famlookup <- read_xlsx(tax_data_path, 
                       sheet = "arthropod.families") %>%
  select(final_lowest, 
         final_ID = 'final species_name',
         family:kingdom) %>%
  distinct()

d_otus <- read.csv("data/ITS_CO1datacombined.csv") %>%
  filter(fam != "",
         fam != "Chaoboridae", # fully aquatic
         fam != "Coenagrionidae") %>% # fully aquatic
  mutate(lineage = paste0("r__Arthro.;c__", class, ";o__", order, ";f__", fam)) %>%
  select(otu_id, lineage, Soil1:Water2)

d_samples <- data.frame(sample_id = c("Soil1", "Soil2", "Soil3", "Soil4", "Soil5",
                                      "Roller2", "Roller3", "Roller5",
                                      "Spray3", "Spray4", "Spray5",
                                      "Water1", "Water2"),
                        Method = c(rep("Soil", 5), rep("Roller", 3), 
                                   rep("Spray", 3), rep("Water", 2)))

dl <- read.csv("data/ITS_CO1datacombined.csv") %>%
  select(fam, hab, feed, size_cat, Soil1:Water2) %>%
    filter(fam != "",
         fam != "Chaoboridae", # fully aquatic
         fam != "Coenagrionidae") %>% # fully aquatic
  pivot_longer(cols = Soil1:Water2) %>%
  mutate(type = substr(name, 1,3)) %>%
  group_by(fam, hab, feed, size_cat, type) %>%
  summarize(total = sum(value)) %>%
  ungroup() %>%
  arrange(type, fam) %>%
  filter(is.na(fam) != T) %>%
  mutate(Method = case_when(type == "Soi" ~ "Soil",
                            type == "Spr" ~ "Spray",
                            type == "Rol" ~ "Roller",
                            type == "Wat" ~ "Water"),
         Guild = case_when(feed == "Omin" ~ "Omnivore",
                           feed == "Para" ~ "Parasitoid",
                           feed == "Pred/phyto" ~ "Mixed",
                           feed == "Predator, Phyto" ~ "Mixed",
                           feed == "Variety" ~ "Mixed",
                           feed == "Phyto" ~ "Phytoph.",
                           feed == "Predator" ~ "Predator"),
         Habitat = case_when(hab == "T" ~ "Terrestrial",
                           hab == "A" ~ "Aquatic",
                           hab == "A/T" ~ "Mixed"),
         Body_Size = case_when(size_cat == "Large" ~ ">20 mm",
                               size_cat == "Medium" ~ "10-20 mm",
                               size_cat == "Small" ~ "5-10 mm",
                               size_cat == "Tiny" ~ "<5 mm",
                               size_cat == "" ~ "Unknown"),
         Body_Size_order = case_when(Body_Size == "<5 mm" ~ 5,
                           Body_Size == "5-10 mm" ~ 4,
                           Body_Size == "10-20 mm" ~ 3,
                           Body_Size == ">20 mm" ~ 2,
                           Body_Size == "Unknown" ~ 1),
         Habitat_order = case_when(Habitat == "Terrestrial" ~ 2,
                           Habitat == "Aquatic" ~ 3,
                           Habitat == "Mixed" ~ 1),
         Guild_order = case_when(Guild == "Predator" ~ 5,
                           Guild == "Phytoph." ~ 4,
                           Guild == "Omnivore" ~ 3,
                           Guild == "Parasitoid" ~ 2,
                           Guild == "Mixed" ~ 1))
```
# Feeding Guild
```{r}
(feed <- dl %>%
    mutate(Guild = fct_reorder(Guild, desc(Guild_order))) %>%
ggplot(aes(x = Method, y = total, fill = Guild)) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete=TRUE) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab ("Proportion of OTUs") + 
  xlab("") +
  ggtitle("Feeding Guild") +
  theme(axis.text.x = element_text(size = 15)))
# ggsave("figures/feeding_guild_no_aquatic.jpg", width = 6, height = 6, dpi = 400)
```
# Habitat
```{r}
(hab <- dl %>%
  mutate(Habitat = fct_reorder(Habitat, desc(Habitat_order))) %>%
ggplot(aes(x = Method, y = total, fill = Habitat)) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete=TRUE) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab ("Proportion of OTUs") + 
  xlab("") +
  ggtitle("Habitat") +
  theme(axis.text.x = element_text(size = 15)))
# ggsave("figures/habitat_no_aquatic.jpg", width = 6, height = 6, dpi = 400)
```
# Body Size
```{r}
(size <- dl %>%
  mutate(Body_Size = fct_reorder(Body_Size, desc(Body_Size_order))) %>%
  ggplot(aes(x = Method, y = total, fill = Body_Size)) +
  theme_bw() +
  viridis::scale_fill_viridis(discrete=TRUE) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab ("Proportion of OTUs") + 
  labs(fill = "Body Size") +
  xlab("") +
  ggtitle("Body Size") +
  theme(axis.text.x = element_text(size = 15)))
# ggsave("figures/body_size_no_aquatic.jpg", width = 6, height = 6, dpi = 400)

require(gridExtra)
grid.arrange(feed, size, hab, ncol=3)

# ggsave("figures/whos_there_no_aquatic.jpg", arrangeGrob(feed, size, hab), width= 7, height = 7, dpi = 500)
```
# Species accumulation curves
used code from here: https://rpubs.com/Roeland-KINDT/694021
and: http://biological-complexity.blogspot.com/2018/01/on-species-accumulation-curves.html
```{r}
library(BiodiversityR) # also loads vegan
library(ggplot2)
# library(ggsci)
# library(readxl)

spray_roll_mat <- as.matrix(select(d_otus, starts_with("Roll"), 
                                starts_with("Spray"))) %>%
  t()
spray_roll_mat[spray_roll_mat>0] <- 1 

soil_mat <- as.matrix(select(d_otus, starts_with("Soil"))) %>%
  t()
soil_mat[soil_mat>0] <- 1 


accum.spray_roll <- accumcomp(spray_roll_mat, 
                     y=data.frame(method = rep("spray_roll", 6)),
                     factor='method', 
  method='exact', conditioned=FALSE, plotit=FALSE)
accum.spray_roll

accum.soil <- accumcomp(soil_mat, 
                     y=data.frame(method = rep("soil", 5)),
                     factor='method', 
  method='exact', conditioned=FALSE, plotit=FALSE)
accum.soil

plot.data.spray_roll <- data.frame(samples = c(accum.spray_roll[,,1]), 
           s = c(accum.spray_roll[,,2]), 
           sd = c(accum.spray_roll[,,3]),
           method = "spray_roll")

plot.data.soil <- data.frame(samples = c(accum.soil[,,1]), 
           s = c(accum.soil[,,2]), 
           sd = c(accum.soil[,,3]),
           method = "soil")

plot.data <- plot.data.spray_roll %>%
  bind_rows(plot.data.soil)

ggplot(plot.data) +
  geom_ribbon(aes(x = samples, ymin = s-2*sd, 
                  ymax = s+2*sd, fill = method),
              alpha = 0.5) +  
  geom_line(aes(x = samples, y = s, group = method), size = 1) +
  scale_fill_manual(values = c("darkgreen", "steelblue")) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "No. samples", y = "No. families")


# ggsave("species_accumulation_curve_spray_roll_soil.png", 
#        dpi = 600, width = 6, height = 4)
```

